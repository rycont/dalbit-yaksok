# 토크나이저: 코드의 첫인상, 단어 쪼개기 마법사 🧙‍♀️

여러분, 달빛약속 코드가 컴퓨터 친구에게 전달될 때 가장 먼저 만나는 친구가 누군지 아세요? 바로 **토크나이저(Tokenizer)**랍니다! 이 친구는 우리가 정성껏 작성한 달빛약속 코드(예: `보여주기 "안녕!"`)를 받아서, 마치 우리가 글을 읽을 때 단어 단위로 이해하듯, 컴퓨터가 알아보기 쉬운 작은 조각들, 즉 **토큰(Token)**으로 착착 나눠주는 마법사 같은 역할을 해요. 이 과정을 전문용어로는 **토큰화(Tokenization)** 또는 조금 더 어렵게는 어휘 분석(Lexical Analysis)이라고 부르기도 한답니다.

토크나이저 마법사는 `core/prepare/tokenize/` 폴더에 살고 있어요. 한번 그 마법의 비밀을 살짝 들여다볼까요?

## 토크나이저 마법사의 주된 임무 📜

*   **코드 한 글자 한 글자 꼼꼼히 읽기**: 우리가 쓴 코드를 처음부터 끝까지 한 글자도 빼놓지 않고 살펴봐요.
*   **의미 있는 덩어리로 묶기**: 그냥 글자들을 나열하는 게 아니라, "아, 이건 '보여주기'라는 특별한 약속이구나!", "이건 '나의변수'라는 이름표네?", "이건 숫자 100이네!" 하고 의미 있는 덩어리(토큰)로 묶어줘요. 이 덩어리를 찾을 때는 미리 정해둔 마법 주문서(규칙)를 참고한답니다.
*   **토큰에 이름표와 정보 달아주기**: 각 토큰 덩어리에는 이름표(타입), 실제 내용물(값), 그리고 "이건 코드 몇 번째 줄, 몇 번째 글자에서 찾았어!" 하는 위치 정보도 친절하게 붙여줘요.
*   **조용히 할 건 조용히**: 때로는 주석처럼 컴퓨터는 몰라도 되는 부분이나, 의미 없는 공백은 살짝 옆으로 치워두기도 해요. (하지만 달빛약속에서는 들여쓰기 공백은 아주 중요하게 생각한답니다! 😉)

## 토크나이저 마법 도구 상자 살펴보기 🧰

토크나이저 마법사가 쓰는 몇 가지 중요한 도구들이 있어요.

*   **마법의 중심, `Tokenizer` 클래스 (`core/prepare/tokenize/index.ts`)**:
    *   모든 마법이 시작되는 곳이에요! `tokenize()`라는 특별한 주문을 외우면 실제 토큰화 작업이 진행된답니다.
    *   아, 그리고 코드를 받으면 `preprocess()`라는 준비 마법으로 줄바꿈 같은 것들을 깔끔하게 정리하는 것도 잊지 않아요.
*   **토큰의 모든 것, `token.ts` (`core/prepare/tokenize/token.ts`)**:
    *   여기에는 `Token`이 어떻게 생겼는지 (설계도 같은 거예요!) 정의되어 있어요. 보통 토큰은 이런 정보들을 가지고 있답니다:
        *   `type: TOKEN_TYPE`: 이 토큰이 어떤 종류인지 알려주는 이름표예요. 예를 들어 `KEYWORD_IF` (만약), `IDENTIFIER` (이름표), `NUMBER_LITERAL` (숫자 값) 같은 것들이 있죠.
        *   `value: string | unknown`: 토큰의 실제 알맹이예요. 변수 이름이라면 그 이름(예: "나의변수"), 숫자라면 그 숫자 값(예: 100)이 들어있어요.
        *   `position: Position`: 코드에서 이 토큰이 어디서 시작됐는지 알려주는 지도 좌표 같은 거예요 (몇 번째 줄, 몇 번째 칸). `Position` 타입은 `core/type/position.ts` 파일에 정의되어 있답니다.
    *   `TOKEN_TYPE`이라는 이름표 모음집(enum)도 여기에 있어서, 달빛약속에서 쓰는 모든 토큰 종류를 한눈에 볼 수 있어요.
*   **마법 주문서, `RULES` (`core/prepare/tokenize/rules.ts`)**:
    *   토크나이저가 어떤 글자 덩어리를 어떤 토큰으로 바꿔야 할지 적어둔 비밀 주문서예요! `RULES`라는 목록 안에는 여러 개의 주문(규칙)들이 들어있죠. 각 주문은 보통 이렇게 생겼어요:
        *   `type: TOKEN_TYPE`: "이 주문이 성공하면, 이런 이름표(타입)를 가진 토큰을 만들어라!"
        *   `starter: string | RegExp | string[]`: "이런 글자로 시작하거나, 이런 패턴을 보이면 이 주문을 한번 외워봐!" 하고 알려주는 힌트예요.
        *   `parse: (view, shift, tokens) => string | unknown`: 진짜 마법이 일어나는 부분! `view()`로 다음 글자를 살짝 엿보고, `shift()`로 글자를 하나씩 읽으면서(소비하면서) 토큰의 알맹이(값)를 만들어내는 함수예요. 가끔은 이전에 만들었던 토큰들(`tokens`)을 참고해서 더 똑똑하게 판단하기도 한답니다.
    *   이 주문서에 적힌 주문 순서도 꽤 중요해요! 예를 들어 "만약"이라는 특별한 약속(키워드) 주문은 "만약에말이야" 같은 일반 이름(식별자) 주문보다 먼저 나와야 헷갈리지 않겠죠?
*   **특별 신호, `signal.ts` (`core/prepare/tokenize/signal.ts`)**:
    *   가끔 `parse` 주문을 외우다가 "어이쿠, 이건 내가 처리할 게 아니네!" 싶을 때가 있어요. 그럴 때 `NotAcceptableSignal` 같은 특별 신호를 보내서, 토크나이저 마법사가 "아, 알았어! 그럼 다음 주문으로 넘어가 볼게!" 하고 다른 주문을 시도하도록 한답니다.

## 토크나이저 마법은 어떻게 펼쳐질까요? ✨ (토큰화 과정)

자, `Tokenizer` 클래스 안에서 마법이 실제로 어떻게 일어나는지 살짝 엿볼까요?

1.  **준비 땅! (초기화)**: 마법사는 우리가 준 달빛약속 코드를 받고, "자, 이제 시작해볼까?" 하며 필요한 준비(현재 위치 기억 등)를 해요.
2.  **한 글자씩, 앞으로! (루프)**: 코드의 마지막 글자까지 읽을 때까지 아래 마법을 계속 반복해요.
    가. **"이 글자는... 혹시?" (규칙 매칭)**: 지금 보고 있는 글자를 가지고 마법 주문서(`RULES`)를 처음부터 훑어봐요.
    나. **"시작이 좋은데?" (`starter` 일치 확인)**: "오, 이 주문의 시작 힌트(`starter`)랑 지금 글자가 비슷하거나 똑같네?" 싶으면 그 주문을 외워보기로 해요.
    다. **주문을 외워보자! (`parse` 함수 실행)**: 선택된 주문의 `parse` 부분을 실행해요!
        i.  `parse` 함수는 `view()` (다음 글자 훔쳐보기), `shift()` (글자 하나 꿀꺽하고 다음으로 넘어가기) 마법을 써서 글자들을 읽고, "아하! 이만큼이 하나의 토큰이구나!" 하고 토큰의 알맹이(값)를 결정해요.
        ii. 마법이 성공해서 토큰 알맹이가 딱! 만들어지면, 이름표(`type`), 알맹이(`value`), 지도 좌표(`position`)를 붙여서 예쁜 토큰 꾸러미에 쏙 넣어요. 그리고 마법사는 방금 읽은 글자들만큼 앞으로 슝 이동하죠.
        iii. 만약 `parse` 함수가 "앗, 이건 아니야!" (`NotAcceptableSignal`) 신호를 보내면, 마법사는 "괜찮아, 다른 주문도 많으니까!" 하면서 다음 주문을 시도해요. (이때, 이미 살짝 읽었던 글자들은 원래대로 되돌려 놓는 센스! 달빛약속 마법사는 똑똑해서, `parse` 함수가 임시 종이에 글을 써보고 성공할 때만 진짜 종이에 옮겨 적는 방식으로 이걸 처리해요.)
    라. **"음... 넌 누구냐?" (일치 없음)**: 모든 주문을 다 외워봤는데도 지금 글자로 시작하는 토큰을 못 찾겠다면? 마법사는 "흠, 일단 넌 '정체불명 토큰'(`UNKNOWN`)이라고 이름 붙여줄게!" 하고 다음 글자로 넘어간답니다. (아니면 "이런 글자는 우리 약속에 없는데?" 하고 오류를 낼 수도 있어요.)
3.  **특별 마법! 얍! (특수 처리)**:
    *   **"괄호 안에서는 자유롭게 줄 바꿔도 괜찮아!"**: 달빛약속 마법사는 괄호(`[]`, `()`, `{}`) 안에서는 줄바꿈 표시(`NEW_LINE` 토큰)를 살짝 무시해주는 특별한 능력이 있어요. 덕분에 우리가 긴 목록이나 함수 인수를 여러 줄에 걸쳐 예쁘게 적을 수 있답니다.
4.  **마법 끝! (종료)**: 코드의 모든 글자를 다 읽고 나면, 마법사는 지금까지 만든 예쁜 토큰 꾸러미를 다음 친구([파서](./parser.md))에게 전달해줘요.

## 새 키워드 토큰 만들기: `결과`를 추가해볼까요? 뚝딱! 🛠️

만약 우리가 달빛약속에 `결과 <값>`처럼 어떤 값을 결과로 보여주는 새로운 문법을 만들고 싶다고 상상해봐요. 그러려면 `결과`라는 새로운 키워드 토큰이 필요하겠죠? 이렇게 만들 수 있어요!

1.  **`TOKEN_TYPE`에 이름표 추가하기 (`core/prepare/tokenize/token.ts`)**:
    ```typescript
    export enum TOKEN_TYPE {
        // ... 기존 이름표들 ...
        KEYWORD_RESULT = 'KEYWORD_RESULT', // "결과" 이름표 추가!
    }
    ```
2.  **마법 주문서(`RULES`)에 새 주문 추가하기 (`core/prepare/tokenize/rules.ts`)**:
    ```typescript
    // ... 다른 주문들 ...
    {
        type: TOKEN_TYPE.KEYWORD_RESULT, // "이 주문 성공하면 '결과' 이름표 붙여줘!"
        starter: '결', // '결'로 시작하면 이 주문을 한번 쳐다봐 줘.
        parse: (view, shift, tokens) => {
            const keyword = '결과'; // 우리가 찾고 싶은 정확한 단어
            let consumed = ''; // 마법으로 읽어들인 글자들을 임시로 담아둘 곳
            for (let i = 0; i < keyword.length; i++) {
                if (view() === keyword[i]) { // 다음 글자가 '결과'의 각 글자와 일치하나?
                    consumed += shift(); // 일치하면 꿀꺽!
                } else {
                    // "앗, '결' 다음에 '과'가 아니네? 이건 '결과'가 아닌가봐!"
                    throw new NotAcceptableSignal(); // 다른 주문 찾아보자!
                }
            }
            // "혹시 '결과물'처럼 다른 단어의 일부는 아닐까?" 확인하는 마법!
            // 다음 글자가 또 다른 글자(한글, 영어, 숫자, 밑줄)라면 이건 '결과' 키워드가 아니야!
            const nextChar = view();
            if (nextChar && nextChar.match(/[a-zA-Z0-9_가-힣ㄱ-ㅎㅏ-ㅣ]/)) {
                throw new NotAcceptableSignal(); // 다른 주문 찾아보자!
            }
            return consumed; // "좋았어! 정확히 '결과'를 찾았네!" (토큰 값으로 "결과"를 돌려줌)
        },
    },
    // ... (이 주문은 보통 일반 이름(식별자) 주문보다 위에 있어야 해요!) ...
    ```

어때요? 새로운 토큰을 추가하는 것도 그렇게 어렵지 않죠? 중요한 건 `TOKEN_TYPE`에 새 이름표를 만들고, `RULES`에 정확한 주문을 추가해서 마법사가 잘 알아볼 수 있게 하는 거예요. 그리고 다른 주문들, 특히 모든 이름을 다 가져가려고 하는 욕심쟁이 식별자 주문보다 먼저 처리될 수 있도록 순서도 잘 정해줘야 한답니다!

## 다음은 누구? 🤔

토크나이저 마법사가 이렇게 예쁘게 나눠준 토큰 꾸러미는 이제 누구에게 갈까요? 바로 이야기 건축가, [파서(Parser)](./parser.md) 친구랍니다! 파서는 이 토큰들을 가지고 더 멋진 코드 설계도(AST)를 만들 준비를 하고 있을 거예요! 두근두근! 💕
