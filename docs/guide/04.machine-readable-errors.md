# Machine Readable Error 출력

## 개요

기본적으로 달빛 약속의 에러 메시지는 사람이 읽기 쉬운 형식(Human Readable)으로 출력됩니다. 하지만 IDE, 빌드 도구, 또는 자동화된 시스템에서 에러를 처리해야 하는 경우, **Machine Readable** 형식(JSON)으로 에러를 출력할 수 있습니다.

## 사용 방법

`YaksokSession`을 생성할 때 `MACHINE_READABLE_ERROR` 플래그를 활성화하면 됩니다.

### 기본 예제

```typescript
import { YaksokSession, FEATURE_FLAG } from '@dalbit-yaksok/core'

const session = new YaksokSession({
    flags: {
        [FEATURE_FLAG.MACHINE_READABLE_ERROR]: true,
    },
    stderr: (message: string) => {
        // message는 이제 JSON 형식입니다
        console.error(message)
    }
})

session.addModule('main', '정의되지않은변수 보여주기')
await session.runModule('main')
```

## 출력 형식

### Human Readable 형식 (기본값)

```
─────

🚨  문제가 발생했어요 🚨
1번째 줄의 1번째 글자

> 변수 '정의되지않은변수'가 정의되지 않았습니다.

┌─────
│  1  정의되지않은변수 보여주기
│       ^
└─────
```

### Machine Readable 형식 (JSON)

```json
{
  "type": "error",
  "message": "변수 '정의되지않은변수'가 정의되지 않았습니다.",
  "position": {
    "line": 1,
    "column": 1
  },
  "fileName": "main",
  "context": {
    "startLine": 1,
    "endLine": 1,
    "lines": [
      {
        "lineNumber": 1,
        "content": "정의되지않은변수 보여주기",
        "isErrorLine": true
      }
    ]
  }
}
```

## MachineReadableError 인터페이스

```typescript
interface MachineReadableError {
    /**
     * 에러 타입 (현재는 'error'만 지원)
     */
    type: 'error'
    
    /**
     * 에러 메시지
     */
    message: string
    
    /**
     * 에러가 발생한 위치
     * @optional
     */
    position?: {
        line: number      // 1부터 시작하는 줄 번호
        column: number    // 1부터 시작하는 열 번호
    }
    
    /**
     * 에러가 발생한 파일 이름
     * @optional
     */
    fileName?: string
    
    /**
     * 에러 주변의 코드 컨텍스트
     * @optional
     */
    context?: {
        startLine: number
        endLine: number
        lines: Array<{
            lineNumber: number    // 1부터 시작하는 줄 번호
            content: string       // 해당 줄의 코드
            isErrorLine: boolean  // 에러가 발생한 줄인지 여부
        }>
    }
    
    /**
     * 중첩된 에러 (원인 에러)
     * @optional
     */
    child?: MachineReadableError
}
```

## 사용 사례

### 1. IDE 플러그인 개발

에러 정보를 구조화된 형식으로 받아 IDE에 표시하는 데 사용할 수 있습니다.

```typescript
const session = new YaksokSession({
    flags: {
        [FEATURE_FLAG.MACHINE_READABLE_ERROR]: true,
    },
    stderr: (message: string) => {
        const error = JSON.parse(message)
        
        // IDE에 에러 표시
        showDiagnostic({
            file: error.fileName,
            line: error.position?.line,
            column: error.position?.column,
            message: error.message,
        })
    }
})
```

### 2. CI/CD 파이프라인

자동화된 빌드 시스템에서 에러를 처리할 수 있습니다.

```typescript
const session = new YaksokSession({
    flags: {
        [FEATURE_FLAG.MACHINE_READABLE_ERROR]: true,
    },
    stderr: (message: string) => {
        const error = JSON.parse(message)
        
        // 에러 로깅 시스템에 보내기
        logError({
            timestamp: new Date().toISOString(),
            file: error.fileName,
            position: error.position,
            message: error.message,
        })
    }
})
```

### 3. 편집기/컴파일러 개발

언어 서버나 컴파일러에서 구조화된 에러 정보를 사용할 수 있습니다.

```typescript
const errors = []

const session = new YaksokSession({
    flags: {
        [FEATURE_FLAG.MACHINE_READABLE_ERROR]: true,
    },
    stderr: (message: string) => {
        errors.push(JSON.parse(message))
    }
})

// 모든 에러 처리
session.addModule('main', sourceCode)
await session.runModule('main')

// 에러 목록을 다른 도구로 전송
sendErrorsToAnalyzer(errors)
```

## 주의사항

- `MACHINE_READABLE_ERROR` 플래그가 활성화되지 않으면, 기본값인 Human Readable 형식이 사용됩니다.
- Machine Readable 형식의 에러 메시지는 항상 유효한 JSON입니다.
- 에러 메시지를 파싱할 때는 `JSON.parse()`를 사용하세요.

## 예제 코드

### 전체 예제

```typescript
import { YaksokSession, FEATURE_FLAG, type MachineReadableError } from '@dalbit-yaksok/core'

async function runWithMachineReadableErrors() {
    const errors: MachineReadableError[] = []

    const session = new YaksokSession({
        flags: {
            [FEATURE_FLAG.MACHINE_READABLE_ERROR]: true,
        },
        stderr: (message: string) => {
            try {
                const error = JSON.parse(message) as MachineReadableError
                errors.push(error)
                console.log(`Error: ${error.message}`)
                if (error.position) {
                    console.log(`  at ${error.fileName}:${error.position.line}:${error.position.column}`)
                }
            } catch (e) {
                console.error('Failed to parse error:', e)
            }
        }
    })

    session.addModule('main', `
        정의되지않은변수 보여주기
    `)

    const result = await session.runModule('main')

    return {
        result,
        errors
    }
}

// 실행
const { errors } = await runWithMachineReadableErrors()
console.log(`Total errors: ${errors.length}`)
```
